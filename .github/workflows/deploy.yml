name: Deploy Resume via Docker

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      # ✅ 기존 docs 제거
      - name: Clean docs
        run: sudo rm -rf docs

      - name: Build with Docker
        run: |
          export UID_VAL=$(id -u)
          export GID_VAL=$(id -g)
          docker build --no-cache -t resume .
          docker run -u $UID_VAL:$GID_VAL -v ${{ github.workspace }}/docs:/app/docs resume

      # ✅ 혹시 모를 root 생성 폴더를 유저 권한으로 변경
      - name: Fix docs permissions
        run: sudo chown -R $USER:$USER docs

      - name: Sanity check (index language)
        run: |
          echo "payload/index.ts HEAD ===>"
          head -n 20 payload/index.ts || true

      - name: Deploy Korean Resume
        run: |
          mkdir -p docs/ko
          cd docs/ko
          git init
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git checkout -b sub_ko
          git add .
          git commit -m "deploy: ko" || echo "No changes"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin sub_ko --force

      - name: Deploy English Resume
        run: |
          mkdir -p docs/en
          cd docs/en
          git init
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git checkout -b sub_en
          git add .
          git commit -m "deploy: en" || echo "No changes"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin sub_en --force
