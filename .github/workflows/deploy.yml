name: Deploy Resume via Docker

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      # ✅ 기존 docs가 root로 남아있으면 절대 mkdir 안됨 → 반드시 삭제
      - name: Clean docs
        run: sudo rm -rf docs

      - name: Build with Docker
        run: |
          docker build --no-cache -t resume .
          # ✅ uid=1000 로 실행 → 새로 생성되는 docs는 권한 문제 없음
          docker run -u 1000:1000 -v ${{ github.workspace }}/docs:/app/docs resume

      - name: Sanity check (index language)
        run: |
          echo "payload/index.ts HEAD ===>"
          head -n 20 payload/index.ts || true

      - name: Deploy Korean Resume
        run: |
          mkdir -p docs/ko
          cd docs/ko
          git init
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git checkout -b sub_ko
          git add .
          git commit -m "deploy: ko" || echo "No changes"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin sub_ko --force

      - name: Deploy English Resume
        run: |
          mkdir -p docs/en
          cd docs/en
          git init
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git checkout -b sub_en
          git add .
          git commit -m "deploy: en" || echo "No changes"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -u origin sub_en --force
